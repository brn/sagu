"use strict";function promisifyCallback(e,r,n){function t(){for(var e in i)i[e]()}function a(e,r){return function(n){var a=e?{event:n,error:null}:{event:null,error:n},i=babelHelpers.extends({},a,{type:r,dispose:t});e&&s?s(i):o.push(i)}}var o=[],s=null,i={};return(Array.isArray(r)?r:[r]).forEach(function(r,t){r&&(r=r.trim(),i[r]=n(e,r,a(!0,r),a(!1,r)))}),function(){return new Promise(function(e){o.length?e(o.shift()):s=function(r){s=null,e(r)}})}}function match(e,r){return MATCH.call(e,r)}function websocketGenerator(e,r,n){var t=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(e){return new WebSocket(e)},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:["onopen","onmessage"],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:["onerror"];return promisifyCallback(t(e),a.concat(o),function(e,t,a,s){return o.indexOf(t)>-1?r(e,t,s):r(e,t,a),function(){return n(e,t,a,s)}})}function websocket(e){return websocketGenerator(e,function(e,r,n){return e[r]=n},function(e,r,n){return e[r]=null})}function socketio(e,r,n){return websocketGenerator(e,function(e,r,n){return e.on(r,n)},function(e,r,n){return e.off(r,n)},n,(Array.isArray(r)?r:[r]).concat(["connect","event","disconnect","ping","pong","reconnect","reconnect_attempt","reconnecting"]),["error","connect_error","connect_timeout","reconnect_error","reconnect_failed"])}Object.defineProperty(exports,"__esModule",{value:!0});var MATCH=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var r=(this.document||this.ownerDocument).querySelectorAll(e),n=r.length;--n>=0&&r.item(n)!==this;);return n>-1},event=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r,n){var t,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=promisifyCallback("string"==typeof r?document.querySelector(r):r,n,function(e,n,t){var o=a?function(e){match(e.target,a)&&t(e)}:t;return r.addEventListener(n,o,!1),function(){return r.removeEventListener(n,o)}});case 1:return e.next=4,babelHelpers.asyncGenerator.await(t());case 4:return e.next=6,e.sent;case 6:e.next=1;break;case 8:case"end":return e.stop()}},e,this)}));return function(r,n){return e.apply(this,arguments)}}(),wait=function(){var e=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function e(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise(function(e){return setTimeout(function(){return e(n)},r)});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),intervals=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r){var n,t,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,t=0;case 2:if(!n||!a){e.next=9;break}return e.next=6,t++;case 6:n=!1,e.next=13;break;case 9:return e.next=11,babelHelpers.asyncGenerator.await(wait(r,t++));case 11:return e.next=13,e.sent;case 13:e.next=2;break;case 15:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),infinity=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(){var r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=n;case 1:return e.next=4,r++;case 4:e.next=1;break;case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),emitter=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r,n){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=promisifyCallback(r,n,function(e,n,t){return r.on(n,t),function(){return r.off(n,t)}});case 1:return e.next=4,t();case 4:e.next=1;break;case 6:case"end":return e.stop()}},e,this)}));return function(r,n){return e.apply(this,arguments)}}(),readStream=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r){var n,t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=r.body.getReader();case 1:return e.next=4,babelHelpers.asyncGenerator.await(n.read());case 4:return t=e.sent,e.next=7,{chunk:t,reader:n};case 7:e.next=1;break;case 9:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),poll=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r,n){var t,a,o,s,i,u,c,f=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,a=!1,o=void 0,e.prev=3,s=babelHelpers.asyncIterator(infinity(f,!0));case 5:return e.next=7,babelHelpers.asyncGenerator.await(s.next());case 7:return i=e.sent,t=i.done,e.next=11,babelHelpers.asyncGenerator.await(i.value);case 11:if(u=e.sent,t){e.next=21;break}return c=u,e.next=16,babelHelpers.asyncGenerator.await(fetch(r,n).then(function(e){return e.ok?{ok:!0,response:e}:{ok:!1,error:e}},function(e){return{ok:!1,error:e}}));case 16:return e.next=18,e.sent;case 18:t=!0,e.next=5;break;case 21:e.next=27;break;case 23:e.prev=23,e.t0=e.catch(3),a=!0,o=e.t0;case 27:if(e.prev=27,e.prev=28,t||!s.return){e.next=32;break}return e.next=32,babelHelpers.asyncGenerator.await(s.return());case 32:if(e.prev=32,!a){e.next=35;break}throw o;case 35:return e.finish(32);case 36:return e.finish(27);case 37:case"end":return e.stop()}},e,this,[[3,23,27,37],[28,,32,36]])}));return function(r,n){return e.apply(this,arguments)}}(),sse=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r,n){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=promisifyCallback(new EventSource(r),n,function(e,r,n){return e.addEventListener(r,n,!1),function(){return e.removeEventListener(r,n)}});case 1:return e.next=4,babelHelpers.asyncGenerator.await(t());case 4:return e.next=6,e.sent;case 6:e.next=1;break;case 8:case"end":return e.stop()}},e,this)}));return function(r,n){return e.apply(this,arguments)}}(),ws=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r,n){var t,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=void 0,a){e.next=7;break}if(!n){e.next=4;break}throw new Error("Native WebSocket can't specify events parameter.");case 4:t=websocket(r),e.next=8;break;case 7:t=socketio(r,n,a);case 8:return e.next=11,babelHelpers.asyncGenerator.await(t());case 11:return e.next=13,e.sent;case 13:e.next=8;break;case 15:case"end":return e.stop()}},e,this)}));return function(r,n){return e.apply(this,arguments)}}(),retryable=function(){var e=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function e(r,n){var t,a,o,s,i,u,c,f,l=n.options,p=void 0===l?{}:l,b=n.timing,h=void 0===b?function(){return 1e3}:b,v=n.limit,k=void 0===v?5:v,x=n.isFailed,y=void 0===x?function(e){return!e.ok}:x;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=!0,a=!1,o=void 0,e.prev=3,s=babelHelpers.asyncIterator(infinity(1));case 5:return e.next=7,s.next();case 7:return i=e.sent,t=i.done,e.next=11,i.value;case 11:if(u=e.sent,t){e.next=28;break}return c=u,e.next=16,fetch(r,p).catch(function(e){return e});case 16:if(!(f=e.sent)||y(f)){e.next=21;break}return e.abrupt("return",{ok:!0,response:f});case 21:if(!(c>k)){e.next=23;break}return e.abrupt("return",{ok:!1,response:f});case 23:return e.next=25,wait(h(c));case 25:t=!0,e.next=5;break;case 28:e.next=34;break;case 30:e.prev=30,e.t0=e.catch(3),a=!0,o=e.t0;case 34:if(e.prev=34,e.prev=35,t||!s.return){e.next=39;break}return e.next=39,s.return();case 39:if(e.prev=39,!a){e.next=42;break}throw o;case 42:return e.finish(39);case 43:return e.finish(34);case 44:case"end":return e.stop()}},e,this,[[3,30,34,44],[35,,39,43]])}));return function(r,n){return e.apply(this,arguments)}}(),Buffer=function(){function e(r){babelHelpers.classCallCheck(this,e),this._buffer=[],this._isBinary=r,this._locked=!1}return babelHelpers.createClass(e,[{key:"enqueu",value:function(e){this._buffer.push(e)}},{key:"readAll",value:function(){var r=e.concat(this._buffer);return this._isBinary?r:this.toString()}},{key:"toString",value:function(){return this._isBinary?e.conat(this._buffer).toString():e.convertUint8ArrayToUtfString(e.concat(this._buffer))}}],[{key:"concat",value:function(e){var r=e.reduce(function(e,r){return e+r.length},0),n=0;return e.reduce(function(e,r){return e.set(r,n),n+=r.length,e},new Uint8Array(r))}},{key:"convertUint8ArrayToUtfString",value:function(e){for(var r=[],n=0,t=e.length;n<t;){var a=e[n++],o=a>>4;if(o>=0&&o<=7)r.push(String.fromCharCode(a));else if(o>=12&&o<=13){var s=e[n++];r.push(String.fromCharCode((31&a)<<6|63&s))}else if(14===o){var i=e[n++],u=e[n++];r.push(String.fromCharCode((15&a)<<12|(63&i)<<6|(63&u)<<0))}}return r.join("")}}]),e}(),ChunkReader=function(){function e(r){var n=r.chunk,t=r.buffer,a=r.reader;babelHelpers.classCallCheck(this,e),this._chunk=n,this._buffer=t,this._reader=a}return babelHelpers.createClass(e,[{key:"read",value:function(){return this._chunk}},{key:"isBuffered",value:function(){return!!this._buffer}},{key:"drainBuffer",value:function(){return this._buffer?this._buffer.readAll():null}},{key:"cancel",value:function(){this._reader.cancel()}}]),e}(),IS_STREAM_SUPPORTED=!!window.ReadableStream&&!!window.WritableStream,EMPTY_ARRAY=window.Uint8Array?new Uint8Array(new ArrayBuffer(0)):null,FAILED_CHUNK=new ChunkReader({chunk:null,buffer:null,reader:null,ok:!1,done:!0}),stream=function(){var e=babelHelpers.asyncGenerator.wrap(regeneratorRuntime.mark(function e(r,n){var t,a,o,s,i,u,c,f,l,p,b,h,v,k,x,y,d=n.binary,w=void 0!==d&&d,m=n.buffering,g=void 0===m||m,H=babelHelpers.objectWithoutProperties(n,["binary","buffering"]);return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(IS_STREAM_SUPPORTED){e.next=2;break}throw new Error("Stream not supported in this environment!");case 2:return e.next=4,babelHelpers.asyncGenerator.await(retryable(r,H));case 4:if(t=e.sent,a=t.ok,o=t.response,a){e.next=9;break}return e.abrupt("return",FAILED_CHUNK);case 9:s=g?new Buffer(w):null,i=!0,u=!1,c=void 0,e.prev=13,f=babelHelpers.asyncIterator(readStream(o));case 15:return e.next=17,babelHelpers.asyncGenerator.await(f.next());case 17:return l=e.sent,i=l.done,e.next=21,babelHelpers.asyncGenerator.await(l.value);case 21:if(p=e.sent,i){e.next=37;break}if(b=p,h=b.chunk,v=h.value,k=h.done,x=b.reader,!k){e.next=31;break}y=Object.freeze({chunk:new ChunkReader({chunk:EMPTY_ARRAY,buffer:s,reader:x}),ok:a,done:k});case 26:return e.next=29,y;case 29:e.next=26;break;case 31:return g&&s.enqueu(v),e.next=34,Object.freeze({chunk:new ChunkReader({chunk:v,buffer:s,reader:x}),ok:a,done:k});case 34:i=!0,e.next=15;break;case 37:e.next=43;break;case 39:e.prev=39,e.t0=e.catch(13),u=!0,c=e.t0;case 43:if(e.prev=43,e.prev=44,i||!f.return){e.next=48;break}return e.next=48,babelHelpers.asyncGenerator.await(f.return());case 48:if(e.prev=48,!u){e.next=51;break}throw c;case 51:return e.finish(48);case 52:return e.finish(43);case 53:case"end":return e.stop()}},e,this,[[13,39,43,53],[44,,48,52]])}));return function(r,n){return e.apply(this,arguments)}}();exports.event=event,exports.wait=wait,exports.intervals=intervals,exports.infinity=infinity,exports.emitter=emitter,exports.poll=poll,exports.sse=sse,exports.ws=ws,exports.retryable=retryable,exports.Buffer=Buffer,exports.stream=stream;
